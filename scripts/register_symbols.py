#!/usr/bin/env python3
"""
Register index constituent symbols in the database.
Reads from CSV file generated by fetch_index_symbols.py and populates market_symbols table.
"""

import csv
import logging
import sys
from pathlib import Path

# Add src to path so we can import dgas modules
sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from dgas.db import get_connection
from dgas.settings import get_settings

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)

# Paths
DATA_DIR = Path(__file__).parent.parent / "data"
CSV_FILE = DATA_DIR / "index_constituents.csv"


def load_symbols_from_csv(csv_path: Path) -> list[dict]:
    """
    Load symbols from CSV file.

    Args:
        csv_path: Path to CSV file

    Returns:
        List of symbol dictionaries
    """
    logger.info(f"Loading symbols from {csv_path}...")

    symbols = []
    with open(csv_path, "r", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        for row in reader:
            symbols.append(row)

    logger.info(f"Loaded {len(symbols)} symbols from CSV")
    return symbols


def register_symbol(conn, symbol_data: dict) -> int:
    """
    Register a single symbol in the database.

    Args:
        conn: Database connection
        symbol_data: Dictionary with symbol information

    Returns:
        symbol_id of the inserted/updated symbol
    """
    symbol = symbol_data["symbol"]
    name = symbol_data.get("name", "")
    sector = symbol_data.get("sector", "")
    industry = symbol_data.get("industry", "")
    indices = symbol_data.get("indices", "").split(",") if symbol_data.get("indices") else []

    # Upsert symbol
    query = """
        INSERT INTO market_symbols (
            symbol, company_name, exchange, sector, industry, index_membership, is_active
        )
        VALUES (%s, %s, %s, %s, %s, %s, %s)
        ON CONFLICT (symbol) DO UPDATE SET
            company_name = EXCLUDED.company_name,
            sector = EXCLUDED.sector,
            industry = EXCLUDED.industry,
            index_membership = EXCLUDED.index_membership,
            is_active = EXCLUDED.is_active,
            updated_at = NOW()
        RETURNING symbol_id
    """

    cursor = conn.execute(
        query,
        (symbol, name, "US", sector, industry, indices, True)
    )
    result = cursor.fetchone()
    symbol_id = result[0] if result else None

    return symbol_id


def register_all_symbols(csv_path: Path) -> tuple[int, int, int]:
    """
    Register all symbols from CSV into the database.

    Args:
        csv_path: Path to CSV file

    Returns:
        Tuple of (total_symbols, registered_symbols, failed_symbols)
    """
    symbols = load_symbols_from_csv(csv_path)

    registered = 0
    failed = 0

    logger.info("Registering symbols in database...")

    with get_connection() as conn:
        for symbol_data in symbols:
            try:
                symbol_id = register_symbol(conn, symbol_data)
                if symbol_id:
                    registered += 1
                    if registered % 100 == 0:
                        logger.info(f"Registered {registered}/{len(symbols)} symbols...")
                else:
                    failed += 1
                    logger.warning(f"Failed to register {symbol_data['symbol']}")
            except Exception as e:
                failed += 1
                logger.error(f"Error registering {symbol_data['symbol']}: {e}")

    logger.info(f"Registration complete: {registered} registered, {failed} failed")
    return len(symbols), registered, failed


def verify_registration() -> dict:
    """
    Verify symbols were registered correctly.

    Returns:
        Dictionary with verification statistics
    """
    logger.info("Verifying symbol registration...")

    with get_connection() as conn:
        # Count total symbols
        cursor = conn.execute("SELECT COUNT(*) FROM market_symbols")
        total_count = cursor.fetchone()[0]

        # Count by index
        cursor = conn.execute("""
            SELECT COUNT(*) FROM market_symbols
            WHERE 'SP500' = ANY(index_membership)
        """)
        sp500_count = cursor.fetchone()[0]

        cursor = conn.execute("""
            SELECT COUNT(*) FROM market_symbols
            WHERE 'NASDAQ100' = ANY(index_membership)
        """)
        nasdaq100_count = cursor.fetchone()[0]

        cursor = conn.execute("""
            SELECT COUNT(*) FROM market_symbols
            WHERE 'SP500' = ANY(index_membership) AND 'NASDAQ100' = ANY(index_membership)
        """)
        both_count = cursor.fetchone()[0]

        # Sample some symbols
        cursor = conn.execute("""
            SELECT symbol, company_name, sector, industry, index_membership
            FROM market_symbols
            ORDER BY symbol
            LIMIT 5
        """)
        sample = cursor.fetchall()

    stats = {
        "total": total_count,
        "sp500": sp500_count,
        "nasdaq100": nasdaq100_count,
        "both": both_count,
        "sample": sample
    }

    logger.info(f"Total symbols: {total_count}")
    logger.info(f"S&P 500: {sp500_count}")
    logger.info(f"Nasdaq 100: {nasdaq100_count}")
    logger.info(f"In both indices: {both_count}")
    logger.info("\nSample symbols:")
    for sym in sample:
        logger.info(f"  {sym[0]}: {sym[1]} [{', '.join(sym[4])}]")

    return stats


def main():
    """Main execution function."""
    try:
        # Ensure database connection works
        settings = get_settings()
        logger.info(f"Database URL: {settings.database_url}")

        # Check CSV file exists
        if not CSV_FILE.exists():
            logger.error(f"CSV file not found: {CSV_FILE}")
            logger.error("Run fetch_index_symbols.py first to generate CSV file")
            return 1

        # Register all symbols
        total, registered, failed = register_all_symbols(CSV_FILE)

        # Verify registration
        logger.info("=" * 60)
        stats = verify_registration()
        logger.info("=" * 60)

        if failed > 0:
            logger.warning(f"{failed} symbols failed to register")
            return 1

        logger.info("Symbol registration completed successfully!")
        return 0

    except Exception as e:
        logger.error(f"Error during symbol registration: {e}", exc_info=True)
        return 1


if __name__ == "__main__":
    sys.exit(main())
